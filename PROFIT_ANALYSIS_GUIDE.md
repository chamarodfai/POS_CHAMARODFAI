# 💰 ระบบวิเคราะห์กำไรขาดทุน

## ✨ ฟีเจอร์ใหม่ที่เพิ่มเข้ามา

### 🏷️ **ต้นทุนสินค้า (Cost Management)**
- เพิ่มฟิลด์ `cost` ในตารางเมนู
- ระบบจะคำนวณกำไรอัตโนมัติ: `กำไร = ราคาขาย - ต้นทุน`
- Constraint: ราคาขายต้องมากกว่าหรือเท่ากับต้นทุน

### 📊 **การวิเคราะห์กำไร**
- **Gross Profit**: กำไรขั้นต้น (ยอดขาย - ต้นทุน)
- **Net Profit**: กำไรสุทธิ (กำไรขั้นต้น - ส่วนลด)
- **Profit Margin**: อัตรากำไร (กำไร / ยอดขาย × 100)
- **วิเคราะห์รายวัน/เดือน/ปี**

## 🗄️ โครงสร้างฐานข้อมูลที่เปลี่ยน

### ตาราง `menu_items`
```sql
+ cost DECIMAL(10,2) NOT NULL DEFAULT 0    -- ต้นทุนต่อหน่วย
+ CONSTRAINT valid_profit CHECK (price >= cost)
```

### ตาราง `order_items`  
```sql
+ menu_item_cost DECIMAL(10,2) NOT NULL DEFAULT 0    -- ต้นทุนต่อหน่วย
+ total_cost DECIMAL(10,2) NOT NULL DEFAULT 0        -- ต้นทุนรวม
```

### ตาราง `daily_stats`
```sql
+ total_cost DECIMAL(12,2) DEFAULT 0        -- ต้นทุนรวมรายวัน
+ gross_profit DECIMAL(12,2) DEFAULT 0      -- กำไรขั้นต้น
+ net_profit DECIMAL(12,2) DEFAULT 0        -- กำไรสุทธิ
+ profit_margin DECIMAL(5,2) DEFAULT 0      -- อัตรากำไร (%)
```

## 🚀 ฟังก์ชันใหม่ที่ใช้ได้

### 1. วิเคราะห์กำไรภาพรวม
```sql
SELECT * FROM get_profit_analysis('2025-01-01', '2025-01-31');
```
ผลลัพธ์:
- ยอดขายรวม
- ต้นทุนรวม
- กำไรขั้นต้น
- ส่วนลดรวม
- กำไรสุทธิ
- อัตรากำไร
- จำนวนวันขาดทุน/กำไร

### 2. เมนูที่ให้กำไรมากที่สุด
```sql
SELECT * FROM get_most_profitable_items(7, 10);
```
ผลลัพธ์:
- รายชื่อเมนู
- จำนวนขาย
- ยอดขายรวม
- ต้นทุนรวม
- กำไรรวม
- กำไรต่อหน่วย
- อัตรากำไร

### 3. กำไรตามหมวดหมู่
```sql
SELECT * FROM get_sales_by_category('2025-01-01', '2025-01-31');
```
ผลลัพธ์:
- หมวดหมู่อาหาร
- จำนวนขาย
- ยอดขายรวม
- ต้นทุนรวม
- กำไรรวม
- อัตรากำไร

## 💻 การใช้งานใน React Application

### 1. เพิ่มเมนูพร้อมต้นทุน
```javascript
const menuItem = {
  name: "ข้าวผัดกุ้ง",
  price: 80.00,
  cost: 45.00,        // ← ใหม่!
  category: "อาหารจานเดียว",
  description: "ข้าวผัดกุ้งสดใส่ไข่"
};

await menuItemsAPI.create(menuItem);
```

### 2. ดูสถิติกำไร
```javascript
// วิเคราะห์กำไร 30 วันล่าสุด
const analysis = await statsAPI.getProfitAnalysis('2025-01-01', '2025-01-31');
console.log(`กำไรสุทธิ: ${analysis.net_profit} บาท`);
console.log(`อัตรากำไร: ${analysis.profit_margin}%`);

// เมนูที่ให้กำไรมากที่สุด
const topItems = await statsAPI.getMostProfitableItems(7, 5);
topItems.forEach(item => {
  console.log(`${item.menu_item_name}: กำไร ${item.gross_profit} บาท`);
});
```

### 3. สถิติในหน้า Dashboard
```javascript
const stats = await statsAPI.getSummaryStats('2025-01-01', '2025-01-31');

// ข้อมูลที่ได้:
// - totalRevenue: ยอดขายรวม
// - totalCost: ต้นทุนรวม
// - grossProfit: กำไรขั้นต้น
// - netProfit: กำไรสุทธิ
// - profitMargin: อัตรากำไร
```

## 📈 ตัวอย่างการแสดงผลใน Dashboard

### การ์ดสรุปกำไร
```
┌─────────────────────────────────────┐
│  📊 สรุปกำไรประจำเดือน              │
├─────────────────────────────────────┤
│  💰 ยอดขาย:     50,000 บาท         │
│  💸 ต้นทุน:     30,000 บาท         │
│  ✅ กำไรขั้นต้น: 20,000 บาท         │
│  🎁 ส่วนลด:      2,000 บาท         │
│  💎 กำไรสุทธิ:   18,000 บาท         │
│  📈 อัตรากำไร:      40%            │
└─────────────────────────────────────┘
```

### เมนูยอดนิยม (กำไรสูง)
```
1. ข้าวผัดกุ้ง      กำไร: 1,500 บาท  (44%)
2. ต้มยำกุ้ง        กำไร: 1,200 บาท  (46%)  
3. ผัดไทย          กำไร:   800 บาท  (47%)
```

## 🎯 ประโยชน์ที่ได้รับ

### 📊 **การตัดสินใจที่แม่นยำ**
- รู้ว่าเมนูไหนให้กำไรมากที่สุด
- วิเคราะห์หมวดหมู่ที่คุ้มค่า
- ตรวจสอบวันที่ขาดทุน

### 💡 **การปรับปรุงธุรกิจ**
- ปรับราคาขายให้เหมาะสม
- ลดต้นทุนในเมนูที่กำไรต่ำ
- โปรโมทเมนูที่กำไรสูง

### 📈 **การวางแผนระยะยาว**
- พยากรณ์กำไรในอนาคต
- วางเป้าหมายรายเดือน
- ตัวชี้วัดประสิทธิภาพ

## 🔄 การอัปเดตระบบเดิม

### ขั้นตอนการย้ายข้อมูล
1. **รัน SQL Schema ใหม่**: `database_schema_fixed.sql`
2. **อัปเดตข้อมูลเมนูเดิม**: เพิ่มต้นทุนให้เมนูที่มีอยู่
3. **ทดสอบระบบ**: สร้างออเดอร์ใหม่และตรวจสอบการคำนวณ

### สคริปต์อัปเดตข้อมูลเดิม
```sql
-- อัปเดตต้นทุนให้เมนูเดิม (ประมาณ 60% ของราคาขาย)
UPDATE menu_items 
SET cost = ROUND(price * 0.6, 2) 
WHERE cost = 0;
```

---

🎉 **ตอนนี้ระบบ POS มีความสามารถในการวิเคราะห์กำไรขาดทุนแบบครบวงจรแล้ว!** 🎉
